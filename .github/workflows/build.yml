name: Build and Release

on:
  push:
    branches:
      - main    # main åˆ†æ”¯è§¦å‘
      - master  # master åˆ†æ”¯è§¦å‘
  workflow_dispatch:   # æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # æ£€æŸ¥å·²æœ‰tag

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build project
        run: npm run build

      - name: Get version & extension name from extension.json
        id: meta
        run: |
          echo "VERSION=$(jq -r .version extension.json)" >> $GITHUB_ENV
          echo "EEXTNAME=$(jq -r .name extension.json)" >> $GITHUB_ENV

      - name: Check and create tag
        id: check_tag
        run: |
          VERSION=${{ env.VERSION }}
          TAG="v${VERSION}"

          echo "ğŸ” æ£€æŸ¥ tag $TAG æ˜¯å¦å­˜åœ¨..."
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "âš ï¸ Tag $TAG å·²å­˜åœ¨ï¼Œè·³è¿‡å‘å¸ƒã€‚"
            echo "SKIP_RELEASE=true" >> $GITHUB_ENV
          else
            echo "âœ… Tag $TAG ä¸å­˜åœ¨ï¼Œåˆ›å»ºå¹¶æ¨é€ã€‚"
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git tag -a "$TAG" -m "Release $TAG"
            git push origin "$TAG"
            echo "SKIP_RELEASE=false" >> $GITHUB_ENV
          fi

      - name: Extract changelog for version
        if: env.SKIP_RELEASE == 'false'
        id: changelog
        run: |
          VERSION=${{ env.VERSION }}
          EEXTNAME=${{ env.EEXTNAME }}
          echo "ğŸ” Extracting changelog for version $VERSION from CHANGELOG.md"
      
          NOTES=$(awk -v ver="$VERSION" '
            BEGIN {flag=0}
            /^# / {
              if(flag) exit
              if($2==ver){flag=1; next}
            }
            flag {print}
          ' CHANGELOG.md)
      
          NOTES="$NOTES\n\n---\nç”±GitHub Actionsè‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒ\nBuilt and released automatically by GitHub Actions\n\nä¹Ÿå¯å‰å¾€[å˜‰ç«‹åˆ›EDAæ‰©å±•å¹¿åœº](https://ext.lceda.cn/item/oshwhub/${EEXTNAME})ä¸‹è½½\nAlso available at [EasyEDA Extension Plaza](https://ext.easyeda.com/item/oshwhub/${EEXTNAME})"
      
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo -e "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
      
          echo "------ Release Notes ------"
          echo -e "$NOTES"
          echo "---------------------------"


      - name: Debug check artifact
        if: env.SKIP_RELEASE == 'false'
        run: |
          VERSION=${{ env.VERSION }}
          EEXTNAME=${{ env.EEXTNAME }}
          FILE="build/dist/${EEXTNAME}_v${VERSION}.eext"
          if [ -f "$FILE" ]; then
            echo "âœ… äº§ç‰©å­˜åœ¨: $FILE"
          else
            echo "âŒ æœªå‘ç°äº§ç‰©: $FILE"
            ls -R build || true
            exit 1
          fi

      - name: Upload Release
        if: env.SKIP_RELEASE == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: Release v${{ env.VERSION }}
          body: ${{ env.RELEASE_NOTES }}
          files: build/dist/${{ env.EEXTNAME }}_v${{ env.VERSION }}.eext
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

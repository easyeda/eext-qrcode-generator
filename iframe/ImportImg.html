<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>图片导入工具</title>
		<style>
			* {
				margin: 0;
				padding: 0;
				box-sizing: border-box;
			}

			body {
				font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
				background: linear-gradient(135deg, #e3f2fd, #bbdefb);
				display: flex;
				justify-content: center;
				align-items: center;
				height: 100vh;
			}

			.container {
				background-color: white;
				padding: 30px;
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 123, 255, 0.1);
				width: 500px;
				text-align: center;
			}

			h1 {
				color: #1976d2;
				margin-bottom: 20px;
			}

			.file-input-wrapper {
				position: relative;
				display: inline-block;
				margin-bottom: 20px;
			}

			.file-input {
				display: none;
			}

			.file-input-label {
				display: inline-block;
				padding: 10px 20px;
				background-color: #2196f3;
				color: white;
				border-radius: 6px;
				cursor: pointer;
				transition: background-color 0.3s;
			}

			.file-input-label:hover {
				background-color: #1976d2;
			}

			.preview-container {
				margin: 20px 0;
				min-height: 200px;
				border: 2px dashed #90caf9;
				border-radius: 8px;
				display: flex;
				justify-content: center;
				align-items: center;
				background-color: #f1f8fe;
			}

			.preview-image {
				max-width: 100%;
				max-height: 200px;
				border-radius: 6px;
			}

			.placeholder-text {
				color: #64b5f6;
			}

			.import-btn {
				padding: 10px 20px;
				background-color: #42a5f5;
				color: white;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				font-size: 16px;
				transition: background-color 0.3s;
			}

			.import-btn:hover:not(:disabled) {
				background-color: #1e88e5;
			}

			.import-btn:disabled {
				background-color: #bbdefb;
				cursor: not-allowed;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>图片导入工具</h1>
			<div class="file-input-wrapper">
				<input type="file" id="fileInput" class="file-input" accept=".png">
				<label for="fileInput" class="file-input-label">选择 PNG 图片</label>
			</div>
			<div class="preview-container" id="previewContainer">
				<span class="placeholder-text">图片预览区域</span>
			</div>
			<button id="importBtn" class="import-btn" disabled>导入</button>
		</div>

		<script>
			const fileInput = document.getElementById('fileInput');
			const previewContainer = document.getElementById('previewContainer');
			const importBtn = document.getElementById('importBtn');
			let selectedFile = null;

			fileInput.addEventListener('change', function(e) {
				const file = e.target.files[0];
				if (file && file.type === 'image/png') {
					selectedFile = file;
					const reader = new FileReader();
					reader.onload = function(e) {
						previewContainer.innerHTML =
							`<img src="${e.target.result}" class="preview-image" alt="预览图">`;
						importBtn.disabled = false;
					};
					reader.readAsDataURL(file);
				} else {
					alert('请选择 PNG 格式的图片！');
					previewContainer.innerHTML = '<span class="placeholder-text">图片预览区域</span>';
					importBtn.disabled = true;
				}
			});

			importBtn.addEventListener('click', async function() {
				if (!selectedFile) return;

				const reader = new FileReader();
				reader.onload = async function(e) {
					const base64 = e.target.result;
					const img = new Image();
					img.onload = async function() {
						await processImageToEDA(base64, img.width, img.height);
					};
					img.src = base64;
				};
				reader.readAsDataURL(selectedFile);
			});

			function base64ToBlob(base64, mimeType) {
				const byteCharacters = atob(base64.split(',')[1]);
				const byteNumbers = new Array(byteCharacters.length);
				for (let i = 0; i < byteCharacters.length; i++) {
					byteNumbers[i] = byteCharacters.charCodeAt(i);
				}
				const byteArray = new Uint8Array(byteNumbers);
				return new Blob([byteArray], {
					type: mimeType
				});
			}

			async function processImageToEDA(imageData, w, h) {
				try {
					// 假设 eda 对象已经存在
					if (typeof eda === 'undefined') {
						throw new Error('EDA 对象未定义');
					}

					const imageBlob = base64ToBlob(imageData, 'image/png');
					const edaImage = await eda.pcb_MathPolygon.convertImageToComplexPolygon(
						imageBlob, w, h, 0.5, 0.5, 0, 0, true, false
					);
					eda.pcb_PrimitiveImage.create(
						0, 0, edaImage, EPCB_LayerId.TOP_SILKSCREEN, 0, 0, 0, false, false
					);
					showMessage("图片导入成功");
				} catch (error) {
					console.error('处理图像时出错:', error);
					alert('处理图像时出错: ' + error.message);
				}
			}



			// 显示消息函数
			function showMessage(message) {
				// 检查是否已存在样式
				if (!document.getElementById('message-style')) {
					const style = document.createElement('style');
					style.id = 'message-style';
					style.textContent = `
		            @keyframes fadeInOut {
		                0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
		                20% { opacity: 1; transform: translateX(-50%) translateY(0); }
		                80% { opacity: 1; transform: translateX(-50%) translateY(0); }
		                100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
		            }
		            .message {
		                position: fixed;
		                top: 20px;
		                left: 50%;
		                transform: translateX(-50%);
		                background-color: #1e90ff;
		                color: white;
		                padding: 12px 24px;
		                border-radius: 6px;
		                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		                z-index: 1000;
		                animation: fadeInOut 3s forwards;
		            }
		        `;
					document.head.appendChild(style);
				}

				const messageElement = document.createElement('div');
				messageElement.className = 'message';
				messageElement.textContent = message;
				document.body.appendChild(messageElement);

				setTimeout(() => {
					if (document.body.contains(messageElement)) {
						document.body.removeChild(messageElement);
					}
				}, 3000);
			}
		</script>
	</body>
</html>

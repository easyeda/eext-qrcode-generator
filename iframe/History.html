<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÂéÜÂè≤ËÆ∞ÂΩï</title>
  <script src="/iframe/js/JsBarcode.all.min.js"></script>
  <script src="/iframe/js/qrcode.min.js"></script>
  <style>
    /* === iframe ‰∏•‰∏ùÂêàÁºù === */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: "Microsoft YaHei", sans-serif;
      background: #f8f9fa;
    }

    .container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      background: white;
    }

    .table-wrapper {
      flex: 1;
      overflow: auto;
      padding: 0 16px 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
      border: 1px solid #dee2e6;
    }

    thead th {
      position: sticky;
      top: 0;
      z-index: 10;
      background: #e9ecef;
      border: 1px solid #dee2e6;
      font-weight: 600;
      color: #212529;
      font-size: 14px;
      padding: 8px 12px;
      text-align: left;
      white-space: nowrap;
    }

    .filter-icon {
      margin-left: 6px;
      cursor: pointer;
      color: #6c757d;
      font-size: 14px;
    }

    .filter-icon:hover {
      color: #495057;
    }

    .filter-input {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      font-size: 13px;
      box-sizing: border-box;
    }

    .filter-select {
      width: 100%;
      padding: 4px 8px;
      border: 1px solid #ced4da;
      border-radius: 3px;
      font-size: 13px;
      background: white;
    }

    td {
      padding: 8px 12px;
      border: 1px solid #dee2e6;
      font-size: 14px;
      vertical-align: middle;
      color: #0d6efd;
    }

    tr:hover td {
      background-color: #f9f9f9;
    }

    .type-tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
    }

    .qrcode-tag {
      background: #e3f2fd;
      color: #1976d2;
    }

    .barcode-tag {
      background: #f1f8e9;
      color: #388e3c;
    }

    .content-cell {
      font-family: monospace;
      word-break: break-all;
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    .actions {
      padding: 6px 16px;
      text-align: right;
      flex-shrink: 0;
      border-top: 1px solid #eee;
      background: white;
    }

    .btn {
      padding: 6px 12px;
      margin-left: 8px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-outline {
      background: transparent;
      color: #0d6efd;
      border: 1px solid #0d6efd;
    }

    .btn-outline:hover {
      background: #f0f8ff;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
      border: 1px solid #dc3545;
    }

    .btn-danger:hover {
      background: #c82333;
    }

    .empty-row td {
      text-align: center;
      color: #6c757d;
      padding: 20px 0;
    }

    .filter-row {
      background: #fff;
    }

    .filter-row td {
      padding: 6px 12px 4px;
      background: #fff;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>
              Á±ªÂûã
              <span class="filter-icon" id="toggle-filter">üîç</span>
            </th>
            <th>Â∞∫ÂØ∏ (mm)</th>
            <th>
              ÂÜÖÂÆπ
              <!-- ÂèØ‰øùÁïôÂõæÊ†áÔºå‰ΩÜÂÖ±Áî®Âêå‰∏Ä‰∏™ toggle -->
              <span class="filter-icon" id="toggle-filter-2">üîç</span>
            </th>
            <th>
              ÂΩ©Ëâ≤‰∏ùÂç∞
              <span class="filter-icon" id="toggle-filter-3">üîç</span>
            </th>
            <th>Êìç‰Ωú</th>
          </tr>
          <!-- ËøáÊª§Ë°åÔºàÂàùÂßãÈöêËóèÔºâ -->
          <tr class="filter-row" id="filter-row" style="display: none;">
            <td><input type="text" class="filter-input" id="filter-type" placeholder="‰∫åÁª¥Á†Å/Êù°ÂΩ¢Á†Å"></td>
            <td></td>
            <td><input type="text" class="filter-input" id="filter-content" placeholder="ÂÖ≥ÈîÆËØç"></td>
            <td>
              <select class="filter-select" id="filter-color">
                <option value="">ÂÖ®ÈÉ®</option>
                <option value="ÊòØ">ÊòØ</option>
                <option value="Âê¶">Âê¶</option>
              </select>
            </td>
            <td></td>
          </tr>
        </thead>
        <tbody id="history-list">
          <tr class="empty-row">
            <td colspan="5">Âä†ËΩΩ‰∏≠...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="actions">
      <button id="back-btn" class="btn btn-outline">ÂÖ≥Èó≠</button>
      <button id="clear-btn" class="btn btn-danger">Ê∏ÖÁ©∫ÂÖ®ÈÉ®</button>
    </div>
  </div>

  <script>
    let CreateFlag = 0;
    let base64Data = '';
    let type = '';
    let size = '';
    let useColorSilk = '';

    document.addEventListener('DOMContentLoaded', () => {
      const HistoryList = document.getElementById('history-list');
      const BackButton = document.getElementById('back-btn');
      const ClearButton = document.getElementById('clear-btn');
      const filterRow = document.getElementById('filter-row');
      const filterTypeInput = document.getElementById('filter-type');
      const filterContentInput = document.getElementById('filter-content');
      const filterColorSelect = document.getElementById('filter-color');

      // ÊâÄÊúâÂõæÊ†áÈÉΩÊéßÂà∂Âêå‰∏ÄË°å
      document.querySelectorAll('.filter-icon').forEach(icon => {
        icon.addEventListener('click', (e) => {
          e.stopPropagation();
          if (filterRow.style.display === 'none' || !filterRow.style.display) {
            filterRow.style.display = '';
            // ËÅöÁÑ¶Âà∞Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°ÜÔºàÂèØÈÄâÔºâ
            filterTypeInput.focus();
          } else {
            filterRow.style.display = 'none';
          }
        });
      });

      // ÂÆûÊó∂ËøáÊª§
      function setupFilterListeners() {
        [filterTypeInput, filterContentInput].forEach(input => {
          input.addEventListener('input', applyFilters);
        });
        filterColorSelect.addEventListener('change', applyFilters);
      }

      function applyFilters() {
        const typeQuery = filterTypeInput.value.trim().toLowerCase();
        const contentQuery = filterContentInput.value.trim().toLowerCase();
        const colorQuery = filterColorSelect.value; // "ÊòØ" / "Âê¶" / ""

        const rows = HistoryList.querySelectorAll('tr:not(.empty-row)');
        let visibleCount = 0;

        rows.forEach(row => {
          const typeText = row.querySelector('.type-tag')?.textContent.trim().toLowerCase() || '';
          const contentText = row.querySelector('.content-cell')?.textContent.trim().toLowerCase() || '';
          const colorText = row.querySelector('td:nth-child(4)')?.dataset.color || '';

          const typeMatch = typeQuery === '' || typeText.includes(typeQuery);
          const contentMatch = contentQuery === '' || contentText.includes(contentQuery);
          const colorMatch = colorQuery === '' || colorText === colorQuery;

          if (typeMatch && contentMatch && colorMatch) {
            row.style.display = '';
            visibleCount++;
          } else {
            row.style.display = 'none';
          }
        });

        const emptyRow = HistoryList.querySelector('.empty-row');
        if (visibleCount === 0 && rows.length > 0) {
          if (!emptyRow) {
            const tr = document.createElement('tr');
            tr.className = 'empty-row';
            const td = document.createElement('td');
            td.colSpan = 5;
            td.textContent = 'Êó†ÂåπÈÖçËÆ∞ÂΩï';
            td.style.textAlign = 'center';
            td.style.color = '#6c757d';
            td.style.padding = '20px 0';
            tr.appendChild(td);
            HistoryList.appendChild(tr);
          }
        } else if (emptyRow) {
          emptyRow.remove();
        }
      }

      function showMessage(text) {
        const el = document.createElement('div');
        el.style.cssText = `
          position: fixed; top: 16px; left: 50%; transform: translateX(-50%);
          background: #198754; color: white; padding: 8px 16px;
          border-radius: 4px; z-index: 1000; font-size: 14px;
          box-shadow: 0 2px 6px rgba(0,0,0,0.15);
          animation: fadeOut 3s forwards;
        `;
        el.textContent = text;
        document.body.appendChild(el);
        setTimeout(() => el.parentNode?.removeChild(el), 3000);
      }

      function showConfirmDialog(title, onConfirm) {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: rgba(0,0,0,0.5); display: flex; align-items: center;
          justify-content: center; z-index: 2000;
        `;
        overlay.innerHTML = `
          <div style="background: white; padding: 20px; border-radius: 8px; max-width: 300px; text-align: center; font-size: 15px;">
            <div style="margin-bottom: 16px; font-weight: 600;">${title}</div>
            <div style="display: flex; gap: 10px; justify-content: center;">
              <button style="flex:1; padding:6px; border:1px solid #ccc; border-radius:4px;">ÂèñÊ∂à</button>
              <button style="flex:1; padding:6px; background:#dc3545; color:white; border:none; border-radius:4px;">Á°ÆÂÆö</button>
            </div>
          </div>
        `;
        const cancel = overlay.querySelector('button');
        const confirm = overlay.querySelector('button:last-child');
        cancel.onclick = () => document.body.removeChild(overlay);
        confirm.onclick = () => {
          onConfirm();
          document.body.removeChild(overlay);
        };
        document.body.appendChild(overlay);
      }

      function generateQRCode(content, color = '#000000') {
        return new Promise(resolve => {
          const canvas = document.createElement('canvas');
          QRCode.toCanvas(canvas, content, {
            width: 100, margin: 2, correctLevel: 3,
            color: { dark: color, light: '#ffffff' }
          }, err => resolve(err ? null : canvas));
        });
      }

      function generateBarcode(content, color = '#000000') {
        try {
          const canvas = document.createElement('canvas');
          JsBarcode(canvas, content, {
            lineColor: color, format: 'CODE128',
            width: 2, height: 80, displayValue: false, margin: 5
          });
          return Promise.resolve(canvas);
        } catch (e) {
          console.error('Êù°ÂΩ¢Á†ÅÁîüÊàêÈîôËØØ:', e);
          return Promise.resolve(null);
        }
      }

      async function deleteHistoryItem(key) {
        await eda.sys_Storage.setExtensionUserConfig(key, null);
        if (typeof eda.sys_Storage.deleteExtensionUserConfig === 'function') {
          await eda.sys_Storage.deleteExtensionUserConfig(key);
        }
      }

      async function loadHistory() {
        try {
          const all = await eda.sys_Storage.getExtensionAllUserConfigs();
          const data = Object.entries(all)
            .filter(([k]) => k.includes('qrcode') || k.includes('barcode'))
            .map(([k, v]) => ({ id: k, ...v }))
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
          renderHistoryList(data);
        } catch (e) {
          console.error('Âä†ËΩΩÂ§±Ë¥•:', e);
          HistoryList.innerHTML = `<tr class="empty-row"><td colspan="5">Âä†ËΩΩÂ§±Ë¥•</td></tr>`;
          showMessage('Âä†ËΩΩÂ§±Ë¥•');
        }
      }

      function renderHistoryList(data) {
        if (!data.length) {
          HistoryList.innerHTML = `<tr class="empty-row"><td colspan="5">ÊöÇÊó†ÂéÜÂè≤ËÆ∞ÂΩï</td></tr>`;
          return;
        }

        HistoryList.innerHTML = '';
        data.forEach(item => {
          const row = document.createElement('tr');
          row.dataset.id = item.id;

          const typeCell = document.createElement('td');
          const tag = document.createElement('span');
          tag.className = `type-tag ${item.type === 'qrcode' ? 'qrcode-tag' : 'barcode-tag'}`;
          tag.textContent = item.type === 'qrcode' ? '‰∫åÁª¥Á†Å' : 'Êù°ÂΩ¢Á†Å';
          typeCell.appendChild(tag);

          const sizeCell = document.createElement('td');
          sizeCell.textContent = item.size;

          const contentCell = document.createElement('td');
          contentCell.className = 'content-cell';
          contentCell.textContent = item.content;
          contentCell.title = item.content;

          const colorCell = document.createElement('td');
          colorCell.textContent = item.useColorSilk ? 'ÊòØ' : 'Âê¶';
          colorCell.dataset.color = item.useColorSilk ? 'ÊòØ' : 'Âê¶';

          const opCell = document.createElement('td');
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-btn';
          delBtn.textContent = 'Âà†Èô§';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            showConfirmDialog('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü', async () => {
              try {
                await deleteHistoryItem(item.id);
                showMessage('Âà†Èô§ÊàêÂäü');
                loadHistory();
                // ÈáçÁΩÆËøáÊª§Âô®
                filterTypeInput.value = '';
                filterContentInput.value = '';
                filterColorSelect.value = '';
                applyFilters();
              } catch (err) {
                console.error('Âà†Èô§Â§±Ë¥•:', err);
                showMessage('Âà†Èô§Â§±Ë¥•');
              }
            });
          };
          opCell.appendChild(delBtn);

          row.addEventListener('click', async () => {
            CreateFlag = 1;
            showMessage("ËØ∑Âú®ÁîªÂ∏É‰∏äÁÇπÂáª‰ª•ÁîüÊàê‰∏ùÂç∞");
            size = item.size;
            type = item.type;
            useColorSilk = item.useColorSilk;

            const color = item.useColorSilk ? item.color : '#000000';
            let canvas = item.type === 'qrcode'
              ? await generateQRCode(item.content, color)
              : await generateBarcode(item.content, color);
            base64Data = canvas ? canvas.toDataURL('image/png') : '';
          });

          row.append(typeCell, sizeCell, contentCell, colorCell, opCell);
          HistoryList.appendChild(row);
        });
        applyFilters();
      }

      window.onblur = async () => {
        if (!CreateFlag) return;
        let h = parseFloat(size), w = parseFloat(size);
        const pt = await eda.pcb_SelectControl.getCurrentMousePosition();
        if (type === "barcode") w *= 3;

        if (useColorSilk) {
          eda.pcb_PrimitiveObject.create(
            EPCB_LayerId.TOP_SILKSCREEN, pt.x, pt.y, base64Data, w, h, 0, false, 'img', false
          );
        } else {
          const blob = base64ToBlob(base64Data, 'image/png');
          const img = await eda.pcb_MathPolygon.convertImageToComplexPolygon(blob, w, h, 0.5, 0.5, 0, 0, true, false);
          eda.pcb_PrimitiveImage.create(pt.x, pt.y, img, EPCB_LayerId.TOP_SILKSCREEN, w, h, 0, false, false);
        }
        CreateFlag = 0;
        showMessage("ÂõæÂÉèÂ∑≤ÁîüÊàê");
      };

      function base64ToBlob(b64, type) {
        const bytes = atob(b64.split(',')[1]);
        const arr = new Uint8Array(bytes.length);
        for (let i = 0; i < bytes.length; i++) arr[i] = bytes.charCodeAt(i);
        return new Blob([arr], { type });
      }

      function closeWindow() {
        eda.sys_IFrame.closeIFrame('');
        eda.sys_IFrame.openIFrame('/iframe/index.html', 600, 600, 'bonding_pad');
      }

      ClearButton.onclick = () => {
        showConfirmDialog('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ', async () => {
          try {
            const all = await eda.sys_Storage.getExtensionAllUserConfigs();
            const keys = Object.keys(all).filter(k => k.includes('qrcode') || k.includes('barcode'));
            let ok = 0;
            for (const k of keys) {
              try { await deleteHistoryItem(k); ok++; } catch (e) { console.error(e); }
            }
            if (ok > 0) {
              showMessage(`ÊàêÂäüÊ∏ÖÁ©∫ ${ok} Êù°ËÆ∞ÂΩï`);
              loadHistory();
              filterTypeInput.value = '';
              filterContentInput.value = '';
              filterColorSelect.value = '';
              applyFilters();
            } else throw new Error();
          } catch {
            showMessage('Ê∏ÖÁ©∫Â§±Ë¥•');
          }
        });
      };

      BackButton.onclick = closeWindow;

      setupFilterListeners();
      loadHistory();
    });
  </script>
</body>
</html>
